# Music Recommender

## High-Level Steps

1. Get the data from the database
2. Find the song file on disk
3. Generate the song vector
4. Store the song vector in the database
5. Get a random song from the library
6. Lookup the song vector from the database by the URI
7. Get the 10 nearest neighbors from the database
8. Add the songs to the queue

## My Library

Get the list of all items in the library.

**Request**

```bash
curl --location {{HOST}}'/api/services/music_assistant/search?return_response=null' \
--header 'Content-Type: application/json' \
--header 'Authorization: Bearer {{TOKEN}}' \
--data '{
    "library_only": "true",
    "config_entry_id": "{{CONFIG_ID}}",
    "name": "",
    "media_type": "track"
}'
```

```typescript
type Response = {
  service_response: ServiceResponse;
};

interface ServiceResponse {
  artists: Artist[];
  albums: Album[];
  tracks: Track[];
  playlists: Playlist[];
  radio: Radio[];
  audiobooks: any[];
  podcasts: any[];
}

interface Artist {
  media_type: string;
  uri: string;
  name: string;
  version: string;
  image?: string;
}

interface Album {
  media_type: string;
  uri: string;
  name: string;
  version: string;
  image: string;
  artists: Artist[];
}

interface Track {
  media_type: string;
  uri: string;
  name: string;
  version: string;
  image: string;
  artists: Artist[];
  album: Album;
}

interface Playlist {
  media_type: string;
  uri: string;
  name: string;
  version: string;
  image?: string;
}

interface Radio {
  media_type: string;
  uri: string;
  name: string;
  version: string;
  image: string;
}
```

Example Tracks:

```json
{
    "media_type": "track",
    "uri": "library://track/1670",
    "name": "1000 Doves",
    "version": "",
    "image": "",
    "artists": [
        {
            "media_type": "artist",
            "uri": "library://artist/37",
            "name": "Lady Gaga",
            "version": "",
            "image": null
        }
    ],
    "album": {
        "media_type": "album",
        "uri": "library://album/33",
        "name": "Chromatica",
        "version": "",
        "image": null
    }
},
{
    "media_type": "track",
    "uri": "library://track/6205",
    "name": "1000 Nights",
    "version": "",
    "image": "",
    "artists": [
        {
            "media_type": "artist",
            "uri": "library://artist/1346",
            "name": "Ed Sheeran feat. Meek Mill & A Boogie Wit da Hoodie",
            "version": "",
            "image": null
        }
    ],
    "album": {
        "media_type": "album",
        "uri": "library://album/403",
        "name": "No.6 Collaborations Project",
        "version": "",
        "image": null
    }
},
```

## Music Files 

Files are stored on disk 

Example:

```bash
/music$ cd Lady\ Gaga/
/music/Lady Gaga$ cd Chromatica/
/music/Lady Gaga/Chromatica$ ls
'01 - Chromatica I.mp3'  '07 - Chromatica II.mp3'  '13 - Chromatica III.mp3'
'02 - Alice.mp3'         '08 - 911.mp3'            '14 - Sine From Above.mp3'
'03 - Stupid Love.mp3'   '09 - Plastic Doll.mp3'   '15 - 1000 Doves.mp3'
'04 - Rain on Me.mp3'    '10 - Sour Candy.mp3'     '16 - Babylon.mp3'
'05 - Free Woman.mp3'    '11 - Enigma.mp3'          albumart.jpg
'06 - Fun Tonight.mp3'   '12 - Replay.mp3'
```	

## Data Preparation

Data is extracted into a postgreSQL database. The data is stored in a table with the following columns:

```sql
CREATE TABLE "track" (
  "uri" text PRIMARY KEY NOT NULL,
	"name" text NOT NULL,
	"artist" text[] NOT NULL,
	"album" text NOT NULL,
	"embedding" vector(256)
);
```

The artists array is guaranteed to contain the artist name of the album. If there are multiple artists, it can not be said under which artist the song is stored on the disk. All have to be tried to find the correct one.

## Generate the Song Vector

The song vector is generated using OpenL3 and stored in the database. The song vector is a 256-dimensional vector that represents the audio content of the song. The vector is generated by passing the audio file through a pre-trained neural network model.